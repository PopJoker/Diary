const { Point } = require('@influxdata/influxdb-client');
const { writeApi } = require('./influxdb');

const tagSchema = {
    worksheet:["orderId"],
    cellsort: ["orderId", "SortResult", "SortPort"], 
    corepack: ["orderId"],
    daq970cellmeasure: [],
    combine: [],
    etest: ["result"],
    package: [],
};

function writeInflux(data) {
    return new Promise((resolve, reject) => {
        const measurement = data.stage;
        const tags = tagSchema[measurement] || [];
        const point = new Point(measurement);

        // Tags
        tags.forEach(tag => {
            if (data[tag] !== undefined && data[tag] !== null) {
                point.tag(tag, String(data[tag]));
            }
        });

        // Fields
        Object.keys(data).forEach(key => {
            if (tags.includes(key) || key === "TimeStamp" || key === "stage") return;
            const value = data[key];
            if (value === undefined || value === null) return;
            if (!isNaN(Number(value))) point.floatField(key, Number(value));
            else point.stringField(key, String(value));
        });

        // Timestamp
        point.timestamp(data.TimeStamp ? new Date(data.TimeStamp) : new Date());

        console.log(`[Influx] Writing: ${point.toLineProtocol()}`);
        writeApi.writePoint(point);

        writeApi
            .flush()
            .then(() => resolve())
            .catch(err => {
                console.error("Influx flush error:", err);
                reject(err);
            });
    });
}


module.exports = { writeInflux, tagSchema };
